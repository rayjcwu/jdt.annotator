jdt.annotator
==============
This project is based on [Eclipse JDT](http://help.eclipse.org/kepler/index.jsp?nav=%2F3) and [ANTLR 4](http://antlr.org/) to annotate java source files. Results are saved in database, you could get all information in massive join `astnode_all` view.

Binary file [jdt.annotator.jar](https://dl.dropboxusercontent.com/u/15553400/jdt.annotator.jar)

# Usage
`java -jar annotator.jar [opts]`, `-s`, `-d`, `-p` are required options to start annotating.

```
usage: annotator.jar
 -d,--jdbc <arg>      jdbc url, currently only support postgresql
                      (jdbc:postgresql://ip:port/database)
 -p,--project <arg>   project name
 -r,--reset           reset all annotated astnode information in database
                      [need to specify --jdbc]
 -s,--src <arg>       absolute root path of files
```

# Schema

| Table         | Column        | Description  |
| ------------- |--------------| --------|
| astnode_all   | astnode_id    | serial number of node added into database, it **DOESN'T** mean the order of appearance in source code |
| | start_pos | starting position of this node in file |
| | length | length of this node |
| | end_pos | ending position of this node in file |
| | line_number | this node is in (line number, column number) in file |
| | column_number | |
| | nodetype_id | For ASTNode, `nodetype_id < 100`. For Token, `nodetype_id >= 100` |
| | nodetype | name of the type of this node |
| | file_id | |
| | file_name | absolute file name |
| | project_id | |
| | project_name | given project name |
| | project_path | given source code folder, `(project_name, project_path)` uniquely specify a "project"|
| | string | *formatted* code snippet of this node |
| | raw | code snippet of this node |
| | binding_key | used to figure out where is this node declared. Only [Name](http://help.eclipse.org/kepler/index.jsp?topic=%2Forg.eclipse.jdt.doc.isv%2Freference%2Fapi%2Forg%2Feclipse%2Fjdt%2Fcore%2Fdom%2FName.html) type `ASTNode` will have non-null value |
| | parent_astnode_id | parent in parse tree, `parent_astnode_id` of root node is `-1`|
| | declared_at_astnode_id | if this node is declared in another place **in this project**, this id could find out that node. if it's declared in another library, it won't show up.|

# How it works

* Use `JDT` to generate ASTs for all files and binding keys for all `Name` nodes.
* Whenever visitor visit an ASTNode, store ASTNode information in that node.
* Whenever visitor leave an ASTNode, store Token informaiton in that node.
* Take all binding keys generated in first step, figure out where is each `Name` node declared.

For documentation of each ASTNode, refer [jdt.core.dom](http://help.eclipse.org/kepler/index.jsp?topic=%2Forg.eclipse.jdt.doc.isv%2Freference%2Fapi%2Forg%2Feclipse%2Fjdt%2Fcore%2Fdom%2Fpackage-summary.html).

# How to modify
To rebuild, you need to install [Maven 3](http://maven.apache.org/). If you want to modify lexer, you need to install [ANTLR 4](http://antlr.org/) as well.

### To modify lexer generated by ANTLR

* Modify `Java.g4` in `src/org/antlr`
* run `generate.sh` to generate new lexer and parser
* rebuild `.jar`

### To rebuild `.jar`

* run `mvn clean package` in project root path, you will find the `.jar` file in `target/`


# Trouble shooting

* `outOfMemoryException`: Allocating more memory for JVM by `java -Xmx2048m -jar â€¦`
* create database in postgresql: `$> createdb database_name` in shell or `CREATE DATABASE database_name` in SQL.
* **why it's SO slow**: Current implementation query database for any information and auto commit for every `INSERT INTO`/`UPDATE`.